# Telegram-бот «Academy»

MVP Telegram-бот для образовательных кампаний. Поддерживаются три сценария (вебинар → подарок, рассылка → «скрытое окно», интерактив → предсказание), хранение данных в Google Sheets и переключение между режимами polling/webhook.

## Основные возможности

- `/start <campaign>` — приветствие, проверка подписки на канал, выдача купона и CTA на сбор контакта.
- `/lottery <campaign>` — взвешенная лотерея со мгновенной выдачей купона.
- `/fortune <campaign>` — интерактивные «предсказания» с переходом к подарку.
- Сбор телефона через `request_contact` или ручной ввод с нормализацией +7XXXXXXXXXX.
- Логирование событий в лист `events`, хранение купонов в `coupons`, лидов — в `leads`.
- Идемпотентность выдачи купонов (один код на пользователя и кампанию).
- Админ-команды `/ping` (health-check) и `/report` (сводные цифры по таблицам).

## Подготовка окружения

1. Создайте сервисный аккаунт в Google Cloud и выдайте ему доступ на редактирование нужной таблицы Google Sheets.
2. Скачайте JSON-ключ и закодируйте его в base64: `base64 -w0 service-account.json`.
3. Создайте файл `.env` по образцу [.env.example](./.env.example) или настройте переменные окружения в панели вашего хостинга (Replit, Railway и т. д.).
4. Установите зависимости: `pip install -r requirements.txt`.

### Переменные окружения

| Переменная | Описание |
| --- | --- |
| `TELEGRAM_BOT_TOKEN` | Токен бота от @BotFather. |
| `MODE` | `polling` (по умолчанию) или `webhook`. |
| `WEBHOOK_URL` | Публичный HTTPS-адрес приложения. Используется только в режиме webhook. |
| `SECRET_TOKEN` | Значение заголовка `X-Telegram-Bot-Api-Secret-Token` для верификации запросов Telegram. |
| `ADMIN_CHAT_ID` | Chat ID для админ-алёртов. Можно указать несколько через запятую (`служебный_чат,личный_ID`) для fallback. |
| `CHANNEL_USERNAME` | Username канала (с `@`), на который проверяется подписка. |
| `GOOGLE_SHEETS_ID` | Идентификатор Google Sheets (часть URL между `/d/` и `/edit`). |
| `GOOGLE_SERVICE_JSON_B64` | base64-строка от JSON-ключа сервисного аккаунта. |
| `PORT` | Порт HTTP-сервера FastAPI (актуально в режиме webhook). |
| `LEADS_UPSERT` | `true/false`. При `true` обновляет лид по паре `(user_id, campaign)` вместо добавления новой строки. |
| `ALERTS_ENABLED` | `true/false`. Глобальный флаг отправки алёртов. |
| `ALERTS_MENTION` | Необязательное упоминание (например, `@username`), добавляется в начало каждого алёрта. |
| `ALERTS_RATE_LIMIT` | Минимальный интервал (в секундах) между одинаковыми алёртами. |
| `ALERTS_BUNDLE_WINDOW` | Окно агрегации (в секундах) для схожих ошибок. |
| `ALERTS_MASK_PHONE` | `true/false`. Управляет маскированием телефона в алёртах (по умолчанию `true`). |
| `ALERTS_TZ` | Таймзона (формат IANA/zoneinfo) для отображения времени в алёртах. Значение по умолчанию — `Europe/Moscow`. |
| `ALERTS_TIME_FORMAT` | Формат отображения даты/времени в алёртах (`strftime`). По умолчанию `%Y-%m-%d %H:%M:%S`. |

### Что такое `campaign`

`campaign` — ярлык источника или сценария, по которому строятся воронка и отчёты. Значение берётся из payload команд `/start`, `/lottery`, `/fortune`, а также может быть назначено результатом лотереи (например, для A/B-тестов). Если payload отсутствует, используется `default`.

Примеры: `default`, `webinar_demo`, `sale_may2025`. Этот ярлык сохраняется в Google Sheets (`leads`, `events`) и используется для сегментации купонов, аналитики и админских алёртов.

### Структура таблицы Google Sheets

| Лист | Поля |
| --- | --- |
| `coupons` | `code`, `campaign`, `status`, `reserved_by`, `reserved_at`, `used_at`. Статус свободного купона — `free` или пустой. |
| `leads` | `user_id`, `username`, `phone`, `campaign`, `created_at`, `status`, `updated_at` (опционально). |
| `events` | `user_id`, `campaign`, `step`, `ts`, `meta_json`. |

## Запуск и режимы

### Локально (режим polling по умолчанию)

```bash
pip install -r requirements.txt
python -m app.main
```

При старте бот гарантированно удалит активный webhook (`deleteWebhook(drop_pending_updates=True)`) и запустит опрос без пропуска апдейтов.

### Режим webhook

1. Установите `MODE=webhook`, задайте `WEBHOOK_URL` и `SECRET_TOKEN`.
2. Запустите `python -m app.main` — бот удалит старый webhook, выставит новый (`setWebhook` с allowed_updates `message`, `callback_query`, `chat_member`) и поднимет FastAPI на `0.0.0.0:<PORT>`.
3. Проверить актуальное состояние можно через `https://api.telegram.org/bot<TOKEN>/getWebhookInfo`.

### Переключение режимов

- Перейти из webhook в polling: выставьте `MODE=polling` и перезапустите приложение. При запуске webhook будет сброшен.
- Перейти из polling в webhook: выставьте `MODE=webhook`, убедитесь, что приложение доступно по HTTPS, и перезапустите.
- При аварийном переключении достаточно одного запуска в нужном режиме — бот сам корректно отключит предыдущий режим.

### Replit

1. Импортируйте репозиторий и откройте файл [`replit.nix`](./replit.nix) — он включает Python 3.11 и pip.
2. В панели *Secrets* задайте переменные окружения (см. таблицу выше).
3. В разделе *Run* пропишите команду `python -m app.main`.
4. Для webhook используйте домен вида `https://<your-project>.<username>.repl.co`, добавьте его в `WEBHOOK_URL` и убедитесь, что Replit запущен, пока бот активен.

## Архитектура проекта

```
app/
  main.py        # Точка входа, выбор режима запуска
  bot.py         # Инициализация бота, регистрация хендлеров
  config.py      # Конфигурация через pydantic-settings
  handlers/      # Сценарии (start, lottery, fortune, contacts, admin)
  keyboards/     # Инлайн- и reply-клавиатуры
  services/      # Интеграции (Google Sheets, купоны, статистика, подписка, телефон)
  storage/       # Aiosqlite для идемпотентности выдачи купонов
  utils/         # Утилиты (форматирование и т. п.)
```

## Чек-лист приёмки

1. `MODE=polling`: `/start webinar_demo` → без подписки ответ `sub_fail`, после подписки `sub_ok`, кнопка «Забрать подарок» выдаёт новый купон, запись появляется в `coupons`/`events`.
2. Повторное нажатие «Забрать подарок» возвращает тот же код (`gift_repeat`).
3. Кнопка «Оставить контакт» отправляет клавиатуру `request_contact`. И контакт, и ручной ввод `+7XXXXXXXXXX` нормализуются, username сохраняется в `leads` в формате `@username` (нижний регистр) или пустой строкой. В алёрте администратору приходит карточка с кликабельным профилем и замаскированным телефоном, в `events` фиксируется шаг `lead` с `meta_json`, содержащим username.
4. `/lottery <campaign>` — возвращает результат лотереи (`draw`) и затем выдаёт купон (`gift`).
5. `/fortune <campaign>` — выдаёт предсказание, логирует `fortune`, показывает CTA на подарок.
6. `MODE=webhook`: при запуске устанавливается webhook (`/tg/webhook` проверяет секрет), `/health` возвращает `{"ok": true}`. После тестов верните `MODE=polling`, чтобы удалить webhook.
7. При исчерпании купонов пользователь видит корректное сообщение, а в `events` фиксируется `no_coupons` и админу отправляется алёрт.

## Troubleshooting

- **Webhook не снимается.** Запустите приложение с `MODE=polling` — при старте бот вызовет `deleteWebhook(drop_pending_updates=True)` и перейдёт в опрос.
- **Нет доступа к таблице.** Проверьте, что сервисный аккаунт добавлен в Google Sheets с правами редактирования. Ошибки авторизации появятся в логах уровня `ERROR`.
- **Ошибка `There is no current event loop`.** Убедитесь, что используете Python 3.11 и запускаете через `python -m app.main` — внутри создаётся и привязывается event loop перед стартом polling.
- **Купоны закончились.** Добавьте новые строки со статусом `free` или пустым, бот автоматически подхватит их при следующей выдаче.

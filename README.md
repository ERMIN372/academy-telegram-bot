# Telegram-–±–æ—Ç ¬´Academy¬ª

MVP Telegram-–±–æ—Ç –¥–ª—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç—Ä–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è (–≤–µ–±–∏–Ω–∞—Ä ‚Üí –ø–æ–¥–∞—Ä–æ–∫, —Ä–∞—Å—Å—ã–ª–∫–∞ ‚Üí ¬´—Å–∫—Ä—ã—Ç–æ–µ –æ–∫–Ω–æ¬ª, –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤ ‚Üí –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ), —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ Google Sheets –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏ polling/webhook.

## –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- `/start <campaign>` ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª, –≤—ã–¥–∞—á–∞ –∫—É–ø–æ–Ω–∞ –∏ CTA –Ω–∞ —Å–±–æ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–∞.
- `/lottery <campaign>` ‚Äî –≤–∑–≤–µ—à–µ–Ω–Ω–∞—è –ª–æ—Ç–µ—Ä–µ—è —Å–æ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –≤—ã–¥–∞—á–µ–π –∫—É–ø–æ–Ω–∞.
- `/fortune <campaign>` ‚Äî –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ ¬´–ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è¬ª —Å –ø–µ—Ä–µ—Ö–æ–¥–æ–º –∫ –ø–æ–¥–∞—Ä–∫—É.
- –°–±–æ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —á–µ—Ä–µ–∑ `request_contact` –∏–ª–∏ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π +7XXXXXXXXXX.
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –≤ –ª–∏—Å—Ç `events`, —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫—É–ø–æ–Ω–æ–≤ –≤ `coupons`, –ª–∏–¥–æ–≤ ‚Äî –≤ `leads`.
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤—ã–¥–∞—á–∏ –∫—É–ø–æ–Ω–æ–≤ (–æ–¥–∏–Ω –∫–æ–¥ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∫–∞–º–ø–∞–Ω–∏—é).
- –ê–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥—ã `/ping` (health-check) –∏ `/report` (—Å–≤–æ–¥–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –ø–æ —Ç–∞–±–ª–∏—Ü–∞–º).

## –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

1. –°–æ–∑–¥–∞–π—Ç–µ —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –≤ Google Cloud –∏ –≤—ã–¥–∞–π—Ç–µ –µ–º—É –¥–æ—Å—Ç—É–ø –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω—É–∂–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã Google Sheets.
2. –°–∫–∞—á–∞–π—Ç–µ JSON-–∫–ª—é—á –∏ –∑–∞–∫–æ–¥–∏—Ä—É–π—Ç–µ –µ–≥–æ –≤ base64: `base64 -w0 service-account.json`.
3. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –ø–æ –æ–±—Ä–∞–∑—Ü—É [.env.example](./.env.example) –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ –ø–∞–Ω–µ–ª–∏ –≤–∞—à–µ–≥–æ —Ö–æ—Å—Ç–∏–Ω–≥–∞ (Replit, Railway –∏ —Ç. –¥.).
4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: `pip install -r requirements.txt`.

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ |
| --- | --- |
| `TELEGRAM_BOT_TOKEN` | –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –æ—Ç @BotFather. |
| `MODE` | `polling` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) –∏–ª–∏ `webhook`. |
| `WEBHOOK_URL` | –ü—É–±–ª–∏—á–Ω—ã–π HTTPS-–∞–¥—Ä–µ—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ webhook. |
| `SECRET_TOKEN` | –ó–Ω–∞—á–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `X-Telegram-Bot-Api-Secret-Token` –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ Telegram. |
| `ADMIN_CHAT_ID` | Chat ID –¥–ª—è –∞–¥–º–∏–Ω-–∞–ª—ë—Ä—Ç–æ–≤. –ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (`—Å–ª—É–∂–µ–±–Ω—ã–π_—á–∞—Ç,–ª–∏—á–Ω—ã–π_ID`) –¥–ª—è fallback. |
| `CHANNEL_USERNAME` | Username –∫–∞–Ω–∞–ª–∞ (—Å `@`), –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞. |
| `GOOGLE_SHEETS_ID` | –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä Google Sheets (—á–∞—Å—Ç—å URL –º–µ–∂–¥—É `/d/` –∏ `/edit`). |
| `GOOGLE_SERVICE_JSON_B64` | base64-—Å—Ç—Ä–æ–∫–∞ –æ—Ç JSON-–∫–ª—é—á–∞ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞. |
| `SHEETS_TZ` | –¢–∞–π–º–∑–æ–Ω–∞ (IANA) –¥–ª—è –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ Google Sheets. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é `Europe/Moscow`. |
| `SHEETS_TIME_FORMAT` | –§–æ—Ä–º–∞—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (`strftime`). –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é `%Y-%m-%d %H:%M:%S`. |
| `PORT` | –ü–æ—Ä—Ç HTTP-—Å–µ—Ä–≤–µ—Ä–∞ FastAPI (–∞–∫—Ç—É–∞–ª—å–Ω–æ –≤ —Ä–µ–∂–∏–º–µ webhook). |
| `LEADS_UPSERT` | `true/false`. –ü—Ä–∏ `true` –æ–±–Ω–æ–≤–ª—è–µ—Ç –ª–∏–¥ –ø–æ –ø–∞—Ä–µ `(user_id, campaign)` –≤–º–µ—Å—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏. |
| `ALERTS_ENABLED` | `true/false`. –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–ª—ë—Ä—Ç–æ–≤. |
| `ALERTS_MENTION` | –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `@username`), –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –Ω–∞—á–∞–ª–æ –∫–∞–∂–¥–æ–≥–æ –∞–ª—ë—Ä—Ç–∞. |
| `ALERTS_RATE_LIMIT` | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö) –º–µ–∂–¥—É –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –∞–ª—ë—Ä—Ç–∞–º–∏. |
| `ALERTS_BUNDLE_WINDOW` | –û–∫–Ω–æ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö) –¥–ª—è —Å—Ö–æ–∂–∏—Ö –æ—à–∏–±–æ–∫. |
| `ALERTS_MASK_PHONE` | `true/false`. –£–ø—Ä–∞–≤–ª—è–µ—Ç –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ –∞–ª—ë—Ä—Ç–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `true`). |
| `ALERTS_TZ` | –¢–∞–π–º–∑–æ–Ω–∞ (—Ñ–æ—Ä–º–∞—Ç IANA/zoneinfo) –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ –∞–ª—ë—Ä—Ç–∞—Ö. –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî `Europe/Moscow`. |
| `ALERTS_TIME_FORMAT` | –§–æ—Ä–º–∞—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏ –≤ –∞–ª—ë—Ä—Ç–∞—Ö (`strftime`). –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é `%Y-%m-%d %H:%M:%S`. |
| `QA_ENABLED` | `true/false`. –í–∫–ª—é—á–∞–µ—Ç Q&A-–º–æ–¥—É–ª—å –∏–Ω—Ç–µ–Ω—Å–∏–≤–∞. |
| `QA_BUTTONS_SHOWN` | `true/false`. –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Ç–µ–º –∫–Ω–æ–ø–∫–∞–º–∏. |
| `QA_FALLBACK_TO_MENU` | `true/false`. –ü—Ä–∏ –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –º–µ–Ω—é —Ç–µ–º. |
| `QA_UNKNOWN_ANSWER` | –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –ø—Ä–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π —Ç–µ–º–µ. |
| `QA_RATE_LIMIT_SECONDS` | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –æ—Ç–≤–µ—Ç–∞–º–∏ –æ–¥–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (—Å–µ–∫—É–Ω–¥—ã). |

> `ADMIN_CHAT_ID` –º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å —á–µ—Ä–µ–∑ @userinfobot –∏–ª–∏ @RawDataBot ‚Äî –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /start –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ç–æ–±—Ä–∞–∂—ë–Ω–Ω—ã–π `id`.

### –ß—Ç–æ —Ç–∞–∫–æ–µ `campaign`

`campaign` ‚Äî —è—Ä–ª—ã–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏–ª–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É —Å—Ç—Ä–æ—è—Ç—Å—è –≤–æ—Ä–æ–Ω–∫–∞ –∏ –æ—Ç—á—ë—Ç—ã. –ó–Ω–∞—á–µ–Ω–∏–µ –±–µ—Ä—ë—Ç—Å—è –∏–∑ payload –∫–æ–º–∞–Ω–¥ `/start`, `/lottery`, `/fortune`, –∞ —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –ª–æ—Ç–µ—Ä–µ–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è A/B-—Ç–µ—Å—Ç–æ–≤). –ï—Å–ª–∏ payload –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `default`.

–ü—Ä–∏–º–µ—Ä—ã: `default`, `webinar_demo`, `sale_may2025`. –≠—Ç–æ—Ç —è—Ä–ª—ã–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ Google Sheets (`leads`, `events`) –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ –∫—É–ø–æ–Ω–æ–≤, –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –∞–¥–º–∏–Ω—Å–∫–∏—Ö –∞–ª—ë—Ä—Ç–æ–≤.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã Google Sheets

| –õ–∏—Å—Ç | –ü–æ–ª—è |
| --- | --- |
| `coupons` | `code`, `campaign`, `status`, `reserved_by`, `reserved_at`, `reserved_at_msk` (–æ–ø—Ü.), `used_at`, `used_at_msk` (–æ–ø—Ü.). –°—Ç–∞—Ç—É—Å —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –∫—É–ø–æ–Ω–∞ ‚Äî `free` –∏–ª–∏ –ø—É—Å—Ç–æ–π. |
| `leads` | `user_id`, `username`, `phone`, `campaign`, `created_at`, `created_at_msk` (–æ–ø—Ü.), `status`, `updated_at` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ). |
| `events` | `user_id`, `campaign`, `step`, `ts`, `ts_msk` (–æ–ø—Ü.), `meta_json`. |

## –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–Ω—Å–∏–≤

### –í–æ—Ä–æ–Ω–∫–∞ ¬´üìù –ó–∞–ø–∏—Å–∞—Ç—å—Å—è¬ª

- –í—Ö–æ–¥ ‚Äî –∫–Ω–æ–ø–∫–∞ ¬´üìù –ó–∞–ø–∏—Å–∞—Ç—å—Å—è¬ª –≤ –º–µ–Ω—é –∏–Ω—Ç–µ–Ω—Å–∏–≤–∞ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ (`sub_ok`).
- –ó–∞–ø—Ä–æ—Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞–º–∏ ¬´üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω¬ª, ¬´–í–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä –≤—Ä—É—á–Ω—É—é¬ª, ¬´–û—Ç–º–µ–Ω–∞¬ª –∏ –ø–æ–¥—Å–∫–∞–∑–∫–æ–π —Ñ–æ—Ä–º–∞—Ç–∞ `+7XXXXXXXXXX`.
- –¢–µ–ª–µ—Ñ–æ–Ω –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç `+7XXXXXXXXXX` (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –Ω–æ–º–µ—Ä–∞, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å `8`, `7` –∏–ª–∏ `9`).
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ¬´–°–ø–∞—Å–∏–±–æ! –°–≤—è–∂–µ–º—Å—è, —É—Ç–æ—á–Ω–∏–º —Ç–æ—á–Ω—ã–µ –¥–∞—Ç—ã –∏ –æ–ø–ª–∞—Ç—É üëå¬ª.
- –ê–ª—ë—Ä—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä—É —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ ¬´üÜï –ù–æ–≤—ã–π –ª–∏–¥ (–ò–Ω—Ç–µ–Ω—Å–∏–≤)¬ª, —Å—Å—ã–ª–∫—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–∞–º–ø–∞–Ω–∏—é, —Ç–µ–ª–µ—Ñ–æ–Ω (—Å –º–∞—Å–∫–æ–π, –µ—Å–ª–∏ `ALERTS_MASK_PHONE=true`), –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è (`ALERTS_TZ` + `ALERTS_TIME_FORMAT`) –∏ —Å—Ç—Ä–æ–∫—É UTC. –ü—Ä–∏ –æ—à–∏–±–∫–µ –∑–∞–ø–∏—Å–∏ –≤ Google Sheets –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–∞ `–û—à–∏–±–∫–∞: DB_WRITE_FAILED`.
- –í Google Sheets (`leads`) —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø–æ–ª—è `user_id`, `@username` (–Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä), –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π `phone`, `campaign`, `created_at` (UTC ISO), –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π `created_at_msk`, `status="new"`. –ü—Ä–∏ `LEADS_UPSERT=true` —Å—Ç—Ä–æ–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ `(user_id, campaign)` —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º `updated_at`.
- –í –ª–∏—Å—Ç `events` –ø–∏—à—É—Ç—Å—è —à–∞–≥–∏ `lead_init`, `phone_received`, `sheets_write_ok`/`sheets_write_failed`, `lead`, `alert_sent`/`alert_skipped`, `lead_duplicate`. –í `meta_json` –Ω–µ—Ç –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞—è–≤–∫–∏ –ø–æ–¥–∞–≤–ª—è—é—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 60 —Å–µ–∫—É–Ω–¥ ‚Äî –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç ¬´–ó–∞—è–≤–∫–∞ —É–∂–µ –ø—Ä–∏–Ω—è—Ç–∞ üëç¬ª.

### Q&A-–º–æ–¥—É–ª—å

- –ú–µ–Ω—é —Ç–µ–º (–ø—Ä–∏ `QA_BUTTONS_SHOWN=true`): üìå –ß—Ç–æ –∑–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤, üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ, üè≠ –ü—Ä–æ–≥—Ä–∞–º–º–∞, üìç –ì–¥–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç, üë©‚Äçüî¨ –°–ø–∏–∫–µ—Ä—ã –∏ —Ç–µ–º—ã, üçΩ –ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ, üí≥ –°—Ç–æ–∏–º–æ—Å—Ç—å, üéì –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç, üìù –ó–∞–ø–∏—Å–∞—Ç—å—Å—è.
- –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç –∏ CTA ¬´üìù –ó–∞–ø–∏—Å–∞—Ç—å—Å—è¬ª (–∫–Ω–æ–ø–∫–∞ + —Ç–µ–∫—Å—Ç), –∞ —Ç–∞–∫–∂–µ –∫–Ω–æ–ø–∫—É ¬´‚óÄÔ∏è –ù–∞–∑–∞–¥¬ª –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –º–µ–Ω—é.
- –°–≤–æ–±–æ–¥–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º (¬´—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ¬ª, ¬´–≥–¥–µ¬ª, ¬´—Å—Ç–æ–∏–º–æ—Å—Ç—å¬ª, ¬´—Å–ø–∏–∫–µ—Ä—ã¬ª, ¬´–ø—Ä–æ–≥—Ä–∞–º–º–∞¬ª, ¬´–µ–¥–∞/–ø–∏—Ç–∞–Ω–∏–µ¬ª, ¬´—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç¬ª, ¬´–∑–∞–ø–∏—Å–∞—Ç—å—Å—è¬ª –∏ –¥—Ä.).
- –ê–Ω—Ç–∏-—Å–ø–∞–º: –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–µ —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ `QA_RATE_LIMIT_SECONDS` —Å–µ–∫—É–Ω–¥ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- –ü—Ä–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–º –≤–æ–ø—Ä–æ—Å–µ: –µ—Å–ª–∏ `QA_FALLBACK_TO_MENU=true`, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è `QA_UNKNOWN_ANSWER` –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –º–µ–Ω—é —Ç–µ–º, –∏–Ω–∞—á–µ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è.
- –ù–∞–∂–∞—Ç–∏—è ¬´üìù –ó–∞–ø–∏—Å–∞—Ç—å—Å—è¬ª —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ `qa_clicked_cta` —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ç–µ–º—ã, –ø–æ—Å–ª–µ —á–µ–≥–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤–æ—Ä–æ–Ω–∫–∞.

### –ê–ª—ë—Ä—Ç—ã –∏ –≤—Ä–µ–º—è

- –ê–ª—ë—Ä—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ª–æ–∫–∞–ª—å `ALERTS_TZ` + `ALERTS_TIME_FORMAT` –∏ –≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞—é—Ç —Å—Ç—Ä–æ–∫—É —Å UTC-–≤—Ä–µ–º–µ–Ω–µ–º.

## –ó–∞–ø—É—Å–∫ –∏ —Ä–µ–∂–∏–º—ã

### –õ–æ–∫–∞–ª—å–Ω–æ (—Ä–µ–∂–∏–º polling –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

```bash
pip install -r requirements.txt
python -m app.main
```

–ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —É–¥–∞–ª–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã–π webhook (`deleteWebhook(drop_pending_updates=True)`) –∏ –∑–∞–ø—É—Å—Ç–∏—Ç –æ–ø—Ä–æ—Å –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–∞ –∞–ø–¥–µ–π—Ç–æ–≤.

### –†–µ–∂–∏–º webhook

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `MODE=webhook`, –∑–∞–¥–∞–π—Ç–µ `WEBHOOK_URL` –∏ `SECRET_TOKEN`.
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `python -m app.main` ‚Äî –±–æ—Ç —É–¥–∞–ª–∏—Ç —Å—Ç–∞—Ä—ã–π webhook, –≤—ã—Å—Ç–∞–≤–∏—Ç –Ω–æ–≤—ã–π (`setWebhook` —Å allowed_updates `message`, `callback_query`, `chat_member`) –∏ –ø–æ–¥–Ω–∏–º–µ—Ç FastAPI –Ω–∞ `0.0.0.0:<PORT>`.
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ `https://api.telegram.org/bot<TOKEN>/getWebhookInfo`.

### –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤

- –ü–µ—Ä–µ–π—Ç–∏ –∏–∑ webhook –≤ polling: –≤—ã—Å—Ç–∞–≤—å—Ç–µ `MODE=polling` –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ webhook –±—É–¥–µ—Ç —Å–±—Ä–æ—à–µ–Ω.
- –ü–µ—Ä–µ–π—Ç–∏ –∏–∑ polling –≤ webhook: –≤—ã—Å—Ç–∞–≤—å—Ç–µ `MODE=webhook`, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ HTTPS, –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ.
- –ü—Ä–∏ –∞–≤–∞—Ä–∏–π–Ω–æ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–¥–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –≤ –Ω—É–∂–Ω–æ–º —Ä–µ–∂–∏–º–µ ‚Äî –±–æ—Ç —Å–∞–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–µ–∂–∏–º.

### Replit

1. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª [`replit.nix`](./replit.nix) ‚Äî –æ–Ω –≤–∫–ª—é—á–∞–µ—Ç Python 3.11 –∏ pip.
2. –í –ø–∞–Ω–µ–ª–∏ *Secrets* –∑–∞–¥–∞–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (—Å–º. —Ç–∞–±–ª–∏—Ü—É –≤—ã—à–µ).
3. –í —Ä–∞–∑–¥–µ–ª–µ *Run* –ø—Ä–æ–ø–∏—à–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É `python -m app.main`.
4. –î–ª—è webhook –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–æ–º–µ–Ω –≤–∏–¥–∞ `https://<your-project>.<username>.repl.co`, –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –≤ `WEBHOOK_URL` –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Replit –∑–∞–ø—É—â–µ–Ω, –ø–æ–∫–∞ –±–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
app/
  main.py        # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –≤—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –∑–∞–ø—É—Å–∫–∞
  bot.py         # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤
  config.py      # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ pydantic-settings
  handlers/      # –°—Ü–µ–Ω–∞—Ä–∏–∏ (start, lottery, fortune, contacts, admin)
  keyboards/     # –ò–Ω–ª–∞–π–Ω- –∏ reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
  services/      # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (Google Sheets, –∫—É–ø–æ–Ω—ã, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –ø–æ–¥–ø–∏—Å–∫–∞, —Ç–µ–ª–µ—Ñ–æ–Ω)
  storage/       # Aiosqlite –¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –≤—ã–¥–∞—á–∏ –∫—É–ø–æ–Ω–æ–≤
  utils/         # –£—Ç–∏–ª–∏—Ç—ã (—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ç. –ø.)
```

## –ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–∏—ë–º–∫–∏

1. `MODE=polling`: `/start webinar_demo` ‚Üí –±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏ –æ—Ç–≤–µ—Ç `sub_fail`, –ø–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∫–∏ `sub_ok`, –∫–Ω–æ–ø–∫–∞ ¬´–ó–∞–±—Ä–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫¬ª –≤—ã–¥–∞—ë—Ç –Ω–æ–≤—ã–π –∫—É–ø–æ–Ω, –∑–∞–ø–∏—Å—å –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ `coupons`/`events`.
2. –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ ¬´–ó–∞–±—Ä–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫¬ª –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ—Ç –∂–µ –∫–æ–¥ (`gift_repeat`).
3. –ö–Ω–æ–ø–∫–∞ ¬´–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç¬ª –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É `request_contact`. –ò –∫–æ–Ω—Ç–∞–∫—Ç, –∏ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ `+7XXXXXXXXXX` –Ω–æ—Ä–º–∞–ª–∏–∑—É—é—Ç—Å—è, username —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `leads` –≤ —Ñ–æ—Ä–º–∞—Ç–µ `@username` (–Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä) –∏–ª–∏ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π. –í –∞–ª—ë—Ä—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫–∞—Ä—Ç–æ—á–∫–∞ —Å –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º –ø—Ä–æ—Ñ–∏–ª–µ–º –∏ –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º, –≤ `events` —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è —à–∞–≥ `lead` —Å `meta_json`, —Å–æ–¥–µ—Ä–∂–∞—â–∏–º username.
4. `/lottery <campaign>` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ª–æ—Ç–µ—Ä–µ–∏ (`draw`) –∏ –∑–∞—Ç–µ–º –≤—ã–¥–∞—ë—Ç –∫—É–ø–æ–Ω (`gift`).
5. `/fortune <campaign>` ‚Äî –≤—ã–¥–∞—ë—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ, –ª–æ–≥–∏—Ä—É–µ—Ç `fortune`, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç CTA –Ω–∞ –ø–æ–¥–∞—Ä–æ–∫.
6. `MODE=webhook`: –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è webhook (`/tg/webhook` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–µ–∫—Ä–µ—Ç), `/health` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `{"ok": true}`. –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤ –≤–µ—Ä–Ω–∏—Ç–µ `MODE=polling`, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å webhook.
7. –ü—Ä–∏ –∏—Å—á–µ—Ä–ø–∞–Ω–∏–∏ –∫—É–ø–æ–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∞ –≤ `events` —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è `no_coupons` –∏ –∞–¥–º–∏–Ω—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∞–ª—ë—Ä—Ç.
8. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ (–ª–∏–¥, —Å–æ–±—ã—Ç–∏–µ –∏–ª–∏ —Ä–µ–∑–µ—Ä–≤ –∫—É–ø–æ–Ω–∞) –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ä—è–¥–æ–º —Å UTC-–ø–æ–ª–µ–º –ø–æ—è–≤–∏–ª–∞—Å—å –∫–æ–ª–æ–Ω–∫–∞ `*_msk` —Å –≤—Ä–µ–º–µ–Ω–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç–µ `%Y-%m-%d %H:%M:%S`.

## Troubleshooting

- **Webhook –Ω–µ —Å–Ω–∏–º–∞–µ—Ç—Å—è.** –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å `MODE=polling` ‚Äî –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç –≤—ã–∑–æ–≤–µ—Ç `deleteWebhook(drop_pending_updates=True)` –∏ –ø–µ—Ä–µ–π–¥—ë—Ç –≤ –æ–ø—Ä–æ—Å.
- **–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ.** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ Google Sheets —Å –ø—Ä–∞–≤–∞–º–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –û—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ—è–≤—è—Ç—Å—è –≤ –ª–æ–≥–∞—Ö —É—Ä–æ–≤–Ω—è `ERROR`.
- **–û—à–∏–±–∫–∞ `There is no current event loop`.** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Python 3.11 –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ —á–µ—Ä–µ–∑ `python -m app.main` ‚Äî –≤–Ω—É—Ç—Ä–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è event loop –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º polling.
- **–ö—É–ø–æ–Ω—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å.** –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `free` –∏–ª–∏ –ø—É—Å—Ç—ã–º, –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç –∏—Ö –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π –≤—ã–¥–∞—á–µ.
